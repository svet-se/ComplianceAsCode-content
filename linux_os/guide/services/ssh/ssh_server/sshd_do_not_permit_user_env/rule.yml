documentation_complete: true

title: 'Do Not Allow SSH Environment Options'

description: |-
    To ensure users are not able to override environment
    variables of the SSH daemon, add or correct the following line
    in <tt>/etc/ssh/sshd_config</tt>:
    <pre>PermitUserEnvironment no</pre>

rationale: |-
    SSH environment options potentially allow users to bypass
    access restriction in some configurations.

severity: medium

identifiers:
    cce@rhel6: 27201-3
    cce@rhel7: 27363-1
    cce@rhel8: 80903-8

references:
    stigid@ol7: "010460"
    stigid@rhel6: "000241"
    srg@rhel6: SRG-OS-000242
    disa@rhel6: '1414'
    cis@rhel7: 5.2.10
    cis@rhel8: 5.2.12
    cis@sle15: 5.2.12
    cjis: 5.5.6
    cui: 3.1.12
    disa: "366"
    hipaa: 164.308(a)(4)(i),164.308(b)(1),164.308(b)(3),164.310(b),164.312(e)(1),164.312(e)(2)(ii)
    nist: AC-17(a),CM-7(a),CM-7(b),CM-6(a)
    nist-csf: PR.IP-1
    srg: SRG-OS-000480-GPOS-00229
    vmmsrg: SRG-OS-000480-VMM-002000
    stigid@rhel7: "010460"
    stigid@sle12: "030150"
    isa-62443-2013: 'SR 7.6'
    isa-62443-2009: 4.3.4.3.2,4.3.4.3.3
    cobit5: BAI10.01,BAI10.02,BAI10.03,BAI10.05
    iso27001-2013: A.12.1.2,A.12.5.1,A.12.6.2,A.14.2.2,A.14.2.3,A.14.2.4
    cis-csc: 11,3,9

ocil_clause: 'PermitUserEnvironment is not disabled'

ocil: |-
    To ensure users are not able to send environment variables, run the following command:
    <pre>$ sudo grep PermitUserEnvironment /etc/ssh/sshd_config</pre>
    If properly configured, output should be:
    <pre>PermitUserEnvironment no</pre>

template:
    name: machine_config_ignition_file
    vars:
        source: |
          #	$OpenBSD: sshd_config,v 1.103 2018/04/09 20:41:22 tj Exp $

          # This is the sshd server system-wide configuration file.  See
          # sshd_config(5) for more information.

          # This sshd was compiled with PATH=/usr/local/bin:/usr/bin:/usr/local/sbin:/usr/sbin

          # The strategy used for options in the default sshd_config shipped with
          # OpenSSH is to specify options with their default value where
          # possible, but leave them commented.  Uncommented options override the
          # default value.

          # If you want to change the port on a SELinux system, you have to tell
          # SELinux about this change.
          # semanage port -a -t ssh_port_t -p tcp #PORTNUMBER
          #
          #Port 22
          #AddressFamily any
          #ListenAddress 0.0.0.0
          #ListenAddress ::

          HostKey /etc/ssh/ssh_host_rsa_key
          HostKey /etc/ssh/ssh_host_ecdsa_key
          HostKey /etc/ssh/ssh_host_ed25519_key

          # Ciphers and keying
          RekeyLimit 512M 1h

          # System-wide Crypto policy:
          # This system is following system-wide crypto policy. The changes to
          # Ciphers, MACs, KexAlgoritms and GSSAPIKexAlgorithsm will not have any
          # effect here. They will be overridden by command-line options passed on
          # the server start up.
          # To opt out, uncomment a line with redefinition of  CRYPTO_POLICY=
          # variable in  /etc/sysconfig/sshd  to overwrite the policy.
          # For more information, see manual page for update-crypto-policies(8).

          # Logging
          #SyslogFacility AUTH
          SyslogFacility AUTHPRIV
          #LogLevel INFO

          # Authentication:

          #LoginGraceTime 2m
          PermitRootLogin no
          StrictModes yes
          #MaxAuthTries 6
          #MaxSessions 10

          PubkeyAuthentication yes

          # The default is to check both .ssh/authorized_keys and .ssh/authorized_keys2
          # but this is overridden so installations will only check .ssh/authorized_keys
          AuthorizedKeysFile	.ssh/authorized_keys

          #AuthorizedPrincipalsFile none

          #AuthorizedKeysCommand none
          #AuthorizedKeysCommandUser nobody

          # For this to work you will also need host keys in /etc/ssh/ssh_known_hosts
          HostbasedAuthentication no
          # Change to yes if you don't trust ~/.ssh/known_hosts for
          # HostbasedAuthentication
          IgnoreUserKnownHosts yes
          # Don't read the user's ~/.rhosts and ~/.shosts files
          IgnoreRhosts yes

          # To disable tunneled clear text passwords, change to no here!
          #PasswordAuthentication yes
          PermitEmptyPasswords no
          PasswordAuthentication no

          # Change to no to disable s/key passwords
          #ChallengeResponseAuthentication yes
          ChallengeResponseAuthentication no

          # Kerberos options
          KerberosAuthentication no
          #KerberosOrLocalPasswd yes
          #KerberosTicketCleanup yes
          #KerberosGetAFSToken no
          #KerberosUseKuserok yes

          # GSSAPI options
          GSSAPIAuthentication no
          GSSAPICleanupCredentials no
          #GSSAPIStrictAcceptorCheck yes
          #GSSAPIKeyExchange no
          #GSSAPIEnablek5users no

          # Set this to 'yes' to enable PAM authentication, account processing,
          # and session processing. If this is enabled, PAM authentication will
          # be allowed through the ChallengeResponseAuthentication and
          # PasswordAuthentication.  Depending on your PAM configuration,
          # PAM authentication via ChallengeResponseAuthentication may bypass
          # the setting of "PermitRootLogin without-password".
          # If you just want the PAM account and session checks to run without
          # PAM authentication, then enable this but set PasswordAuthentication
          # and ChallengeResponseAuthentication to 'no'.
          # WARNING: 'UsePAM no' is not supported in Fedora and may cause several
          # problems.
          UsePAM yes

          #AllowAgentForwarding yes
          #AllowTcpForwarding yes
          #GatewayPorts no
          X11Forwarding yes
          #X11DisplayOffset 10
          #X11UseLocalhost yes
          #PermitTTY yes

          # It is recommended to use pam_motd in /etc/pam.d/sshd instead of PrintMotd,
          # as it is more configurable and versatile than the built-in version.
          PrintMotd no

          PrintLastLog yes
          #TCPKeepAlive yes
          PermitUserEnvironment no
          Compression no
          ClientAliveInterval 600
          ClientAliveCountMax 0
          #UseDNS no
          #PidFile /var/run/sshd.pid
          #MaxStartups 10:30:100
          #PermitTunnel no
          #ChrootDirectory none
          #VersionAddendum none

          # no default banner path
          Banner /etc/issue

          # Accept locale-related environment variables
          AcceptEnv LANG LC_CTYPE LC_NUMERIC LC_TIME LC_COLLATE LC_MONETARY LC_MESSAGES
          AcceptEnv LC_PAPER LC_NAME LC_ADDRESS LC_TELEPHONE LC_MEASUREMENT
          AcceptEnv LC_IDENTIFICATION LC_ALL LANGUAGE
          AcceptEnv XMODIFIERS

          # override default of no subsystems
          Subsystem	sftp	/usr/libexec/openssh/sftp-server

          # Example of overriding settings on a per-user basis
          #Match User anoncvs
          #	X11Forwarding no
          #	AllowTcpForwarding no
          #	PermitTTY no
          #	ForceCommand cvs server

          UsePrivilegeSeparation sandbox
        mode: 0600
        path: /etc/ssh/sshd_config
