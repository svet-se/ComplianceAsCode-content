# platform = multi_platform_sle
# reboot = false
# strategy = restrict
# complexity = low
# disruption = low
- name: Check for duplicate values in master configuration
  ansible.builtin.lineinfile:
    path: /etc/systemd/journald.conf
    create: false
    regexp: ^\s*Storage=
    state: absent
  check_mode: true
  changed_when: false
  register: dupes_master

- name: Deduplicate values from journald master configuration
  ansible.builtin.lineinfile:
    path: /etc/systemd/journald.conf
    create: false
    regexp: ^\s*Storage=
    state: absent
  when: dupes_master.found is defined and dupes_master.found > 1

- name: Collect all config journald files which configure Storage
  ansible.builtin.find:
    paths: /etc/systemd/journald.conf.d/
    contains: ^[\s]*Storage=.*$
    patterns: "*.conf"
  register: journald_dropin_config_files

- name: Deduplicate values from journald dropin configuration
  ansible.builtin.lineinfile:
    path: "{{ item }}"
    create: false
    regexp: ^\s*Storage=
    state: absent
  loop: "{{  journald_dropin_config_files.files }}"

- name: Insert correct line to journald configuration
  ansible.builtin.lineinfile:
    path: /etc/systemd/journald.conf.d/oscap-remedy.conf
    create: true
    regexp: ^\s*Storage=
    line: Storage="persistent"
    state: present
    insertbefore: ^# Storage
    validate: /usr/bin/bash -n %s
