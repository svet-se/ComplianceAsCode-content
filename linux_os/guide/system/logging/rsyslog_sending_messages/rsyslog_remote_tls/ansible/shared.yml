# platform = multi_platform_fedora,multi_platform_ol,multi_platform_rhel,multi_platform_sle
# reboot = false
# strategy = configure
# complexity = low
# disruption = low
{{{ ansible_instantiate_variables("rsyslog_remote_loghost_address") }}}

- name: "{{{ rule_title }}}: Find all files matching /etc/rsyslog.d/*.conf"
  find:
    paths: "/etc/rsyslog.d/"
    pattern: "*.conf"
  register: rsyslog_includes

- name: "{{{ rule_title }}}: Retrieve list of Rsyslog config files"
  set_fact:
    rsyslog_files: "{{ rsyslog_includes.files | map(attribute='path') | list + ['/etc/rsyslog.conf'] }}"

- name: "{{{ rule_title }}}: Fix existing omfwd directives"
  replace:
    path: "{{ item }}"
    regexp: '^(action\s*\(\s*type\s*=\s*"omfwd"(.*(?!.*StreamDriver\s*=\s*"gtls".*)))\)$'
    replace: '\1 StreamDriver="gtls")'
  register: existing_directive_fixed
  loop: "{{ rsyslog_files }}"

- name: "{{{ rule_title }}}: Add missing rsyslog directive"
  lineinfile:
    dest: /etc/rsyslog.conf
    line: "action(type=\"omfwd\" protocol=\"tcp\" Target=\"{{ rsyslog_remote_loghost_address }}\" port=\"6514\" StreamDriver=\"gtls\" StreamDriverMode=\"1\" StreamDriverAuthMode=\"x509/name\" streamdriver.CheckExtendedKeyPurpose=\"on\")"
    create: yes
  when: not existing_directive_fixed.changed
